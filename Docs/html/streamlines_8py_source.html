<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>mitgcm: streamlines.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">mitgcm
   </div>
   <div id="projectbrief">Analysis of MITgcm output using python</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">streamlines.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="streamlines_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html">    1</a></span>&#160;<span class="stringliteral">&quot;&quot;&quot;!</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="stringliteral">A collection of functions for streamlines and related shennanigans.</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral">Streamlines</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="stringliteral">====================</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="stringliteral">Functions for creating and analysing streamlines.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="stringliteral">Streamlines are defined to be the path that a parcel of fluid would follow when advected by an unchanging velocity field - the velocities are constant in time.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="stringliteral">streaklines are defined as the path that a parcel of fluid would follow in the actual flow - the velocity fields change with time.</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">import</span> netCDF4</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keyword">import</span> numba</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#ac4d6c763bdac75600b3778f4e0ea3a31">stream2</a>(u,v,</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;            startx,starty,</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;            grid_object,</div>
<div class="line"><a name="l00023"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#ac4d6c763bdac75600b3778f4e0ea3a31">   23</a></span>&#160;            t_int=2592000,delta_t=3600):</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!A two-dimensional streamline solver. The velocity fields *must* be two dimensional and not vary in time.</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    x_u = grid_object[<span class="stringliteral">&#39;Xp1&#39;</span>][:]</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    y_u = grid_object[<span class="stringliteral">&#39;Y&#39;</span>][:]</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    x_v = grid_object[<span class="stringliteral">&#39;X&#39;</span>][:]</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    y_v = grid_object[<span class="stringliteral">&#39;Yp1&#39;</span>][:]</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    len_x_u = len(x_u)</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    len_y_u = len(y_u)</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    </div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    len_x_v = len(x_v)</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    len_y_v = len(y_v)</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    </div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    x_stream = np.ones((int(t_int/delta_t)+2))*startx</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    y_stream = np.ones((int(t_int/delta_t)+2))*starty</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    t_stream = np.zeros((int(t_int/delta_t)+2))</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    t = 0 <span class="comment">#set the initial time to be zero</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    i=0</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="comment"># Runge-Kutta fourth order method to estimate next position.</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="keywordflow">while</span> t &lt; t_int:</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;      <span class="comment"># Interpolate velocities to initial location</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;      u_loc = <a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(startx,starty,u,x_u,y_u,len_x_u,len_y_u)</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;      v_loc = <a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(startx,starty,v,x_v,y_v,len_x_v,len_y_v)</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;      dx1 = delta_t*u_loc</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;      dy1 = delta_t*v_loc</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;      u_loc1 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(startx + 0.5*dx1,starty + 0.5*dy1,u,x_u,y_u,len_x_u,len_y_u)</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;      v_loc1 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(startx + 0.5*dx1,starty + 0.5*dy1,v,x_v,y_v,len_x_v,len_y_v)</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;      dx2 = delta_t*u_loc1</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;      dy2 = delta_t*v_loc1</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;      u_loc2 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(startx + 0.5*dx2,starty + 0.5*dy2,u,x_u,y_u,len_x_u,len_y_u)</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;      v_loc2 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(startx + 0.5*dx2,starty + 0.5*dy2,v,x_v,y_v,len_x_v,len_y_v)</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;      dx3 = delta_t*u_loc2</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;      dy3 = delta_t*v_loc2</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;      u_loc3 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(startx + dx3,starty + dy3,u,x_u,y_u,len_x_u,len_y_u)</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;      v_loc3 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(startx + dx3,starty + dy3,v,x_v,y_v,len_x_v,len_y_v)</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;      dx4 = delta_t*u_loc3</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;      dy4 = delta_t*v_loc3</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;      startx = startx + (dx1 + 2*dx2 + 2*dx3 + dx4)/6</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;      starty = starty + (dy1 + 2*dy2 + 2*dy3 + dy4)/6</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;      t += delta_t</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;      i += 1</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;      x_stream[i] = startx</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;      y_stream[i] = starty</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;      t_stream[i] = t</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;      </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;      </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordflow">return</span> x_stream,y_stream,t_stream</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#a38690a408e43bb899018203363da090d">stream3</a>(u,v,w,</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            startx,starty,startz,</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            grid_object,</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;            x_v=<span class="stringliteral">&#39;None&#39;</span>,y_v=<span class="stringliteral">&#39;None&#39;</span>,z_v=<span class="stringliteral">&#39;None&#39;</span>,</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            x_w=<span class="stringliteral">&#39;None&#39;</span>,y_w=<span class="stringliteral">&#39;None&#39;</span>,z_w=<span class="stringliteral">&#39;None&#39;</span>,</div>
<div class="line"><a name="l00087"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#a38690a408e43bb899018203363da090d">   87</a></span>&#160;            t_int=2592000,delta_t=3600):</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!A three-dimensional streamline solver. The velocity fields must be three dimensional and not vary in time.</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    x_u = grid_object[<span class="stringliteral">&#39;Xp1&#39;</span>][:]</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    y_u = grid_object[<span class="stringliteral">&#39;Y&#39;</span>][:]</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    z_u = grid_object[<span class="stringliteral">&#39;Z&#39;</span>][:]</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    x_v = grid_object[<span class="stringliteral">&#39;X&#39;</span>][:]</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    y_v = grid_object[<span class="stringliteral">&#39;Yp1&#39;</span>][:]</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    z_v = grid_object[<span class="stringliteral">&#39;Z&#39;</span>][:]</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    x_w = grid_object[<span class="stringliteral">&#39;X&#39;</span>][:]</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    y_w = grid_object[<span class="stringliteral">&#39;Y&#39;</span>][:]</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    z_w = grid_object[<span class="stringliteral">&#39;Zl&#39;</span>][:]</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        </div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    len_x_u = len(x_u)</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    len_y_u = len(y_u)</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    len_z_u = len(z_u)</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    </div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    len_x_v = len(x_v)</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    len_y_v = len(y_v)</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    len_z_v = len(z_v)</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    len_x_w = len(x_w)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    len_y_w = len(y_w)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    len_z_w = len(z_w)</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    x_stream = np.ones((int(t_int/delta_t)+2))*startx</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    y_stream = np.ones((int(t_int/delta_t)+2))*starty</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    z_stream = np.ones((int(t_int/delta_t)+2))*startz</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    t_stream = np.zeros((int(t_int/delta_t)+2))</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    t = 0 <span class="comment">#set the initial time to be zero</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    i=0</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    </div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="comment"># Runge-Kutta fourth order method to estimate next position.</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">while</span> t &lt; t_int:</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;      <span class="comment"># Interpolate velocities to initial location</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;      u_loc = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx,starty,startz,u,x_u,y_u,z_u,len_x_u,len_y_u,len_z_u)</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;      v_loc = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx,starty,startz,v,x_v,y_v,z_v,len_x_v,len_y_v,len_z_v)</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      w_loc = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx,starty,startz,w,x_w,y_w,z_w,len_x_w,len_y_w,len_z_w)</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;      dx1 = delta_t*u_loc</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;      dy1 = delta_t*v_loc</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;      dz1 = delta_t*w_loc</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;      u_loc1 = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx + 0.5*dx1,starty + 0.5*dy1,startz + 0.5*dz1,u,x_u,y_u,z_u,len_x_u,len_y_u,len_z_u)</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;      v_loc1 = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx + 0.5*dx1,starty + 0.5*dy1,startz + 0.5*dz1,v,x_v,y_v,z_v,len_x_v,len_y_v,len_z_v)</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;      w_loc1 = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx + 0.5*dx1,starty + 0.5*dy1,startz + 0.5*dz1,w,x_w,y_w,z_w,len_x_w,len_y_w,len_z_w)</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      dx2 = delta_t*u_loc1</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      dy2 = delta_t*v_loc1</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;      dz2 = delta_t*w_loc1</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;      u_loc2 = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx + 0.5*dx2,starty + 0.5*dy2,startz + 0.5*dz2,u,x_u,y_u,z_u,len_x_u,len_y_u,len_z_u)</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;      v_loc2 = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx + 0.5*dx2,starty + 0.5*dy2,startz + 0.5*dz2,v,x_v,y_v,z_v,len_x_v,len_y_v,len_z_v)</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;      w_loc2 = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx + 0.5*dx2,starty + 0.5*dy2,startz + 0.5*dz2,w,x_w,y_w,z_w,len_x_w,len_y_w,len_z_w)</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;      dx3 = delta_t*u_loc2</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;      dy3 = delta_t*v_loc2</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;      dz3 = delta_t*w_loc2</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      u_loc3 = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx + dx3,starty + dy3,startz + dz3,u,x_u,y_u,z_u,len_x_u,len_y_u,len_z_u)</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      v_loc3 = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx + dx3,starty + dy3,startz + dz3,v,x_v,y_v,z_v,len_x_v,len_y_v,len_z_v)</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      w_loc3 = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(startx + dx3,starty + dy3,startz + dz3,w,x_w,y_w,z_w,len_x_w,len_y_w,len_z_w)</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;      dx4 = delta_t*u_loc3</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      dy4 = delta_t*v_loc3</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;      dz4 = delta_t*w_loc3</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      <span class="comment">#recycle the &quot;start_&quot; variables to keep the code clean</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      startx = startx + (dx1 + 2*dx2 + 2*dx3 + dx4)/6</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;      starty = starty + (dy1 + 2*dy2 + 2*dy3 + dy4)/6</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      startz = startz + (dz1 + 2*dz2 + 2*dz3 + dz4)/6</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      t += delta_t</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;      i += 1</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;      x_stream[i] = startx</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;      y_stream[i] = starty</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;      z_stream[i] = startz</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      t_stream[i] = t</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;      </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keywordflow">return</span> x_stream,y_stream,z_stream,t_stream</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#a493dab136e4b63582d7f6b77e7a9c644">streaklines</a>(u_netcdf_filename,v_netcdf_filename,w_netcdf_filename,</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            startx,starty,startz,startt,</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;            t,</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            grid_object,            </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;            u_netcdf_variable=<span class="stringliteral">&#39;UVEL&#39;</span>,</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            v_netcdf_variable=<span class="stringliteral">&#39;VVEL&#39;</span>,</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            w_netcdf_variable=<span class="stringliteral">&#39;WVEL&#39;</span>,</div>
<div class="line"><a name="l00176"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#a493dab136e4b63582d7f6b77e7a9c644">  176</a></span>&#160;            t_int=3.1e5,delta_t=3600):</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!A three-dimensional lagrangian particle tracker. The velocity fields must be four dimensional (three spatial, one temporal) and have units of m/s.</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="stringliteral">    It should work to track particles forwards or backwards in time (set delta_t &lt;0 for backwards in time). But, be warned, backwards in time hasn&#39;t been tested yet.</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="stringliteral">    </span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="stringliteral">    Because this is a very large amount of data, the fields are passed as netcdffile handles.</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="stringliteral">    </span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="stringliteral">    The variables are:</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="stringliteral">    * ?_netcdf_filename = name of the netcdf file with ?&#39;s data in it.</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="stringliteral">    * start? = intial value for x, y, z, or t.</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="stringliteral">    * t = vector of time levels that are contained in the velocity data.</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="stringliteral">    * grid_object is m.grid if you followed the standard naming conventions.</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="stringliteral">    * ?_netcdf_variable = name of the &quot;?&quot; variable field in the netcdf file.</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="stringliteral">    * t_int = length of time to track particles for, in seconds</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="stringliteral">    * delta_t = timestep for particle tracking algorithm, in seconds. This can be positive or negative.</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    x_u = grid_object[<span class="stringliteral">&#39;Xp1&#39;</span>][:]</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    y_u = grid_object[<span class="stringliteral">&#39;Y&#39;</span>][:]</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    z_u = grid_object[<span class="stringliteral">&#39;Z&#39;</span>][:]</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    x_v = grid_object[<span class="stringliteral">&#39;X&#39;</span>][:]</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    y_v = grid_object[<span class="stringliteral">&#39;Yp1&#39;</span>][:]</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    z_v = grid_object[<span class="stringliteral">&#39;Z&#39;</span>][:]</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    x_w = grid_object[<span class="stringliteral">&#39;X&#39;</span>][:]</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    y_w = grid_object[<span class="stringliteral">&#39;Y&#39;</span>][:]</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    z_w = grid_object[<span class="stringliteral">&#39;Zl&#39;</span>][:]</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    len_x_u = len(x_u)</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    len_y_u = len(y_u)</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    len_z_u = len(z_u)</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    len_x_v = len(x_v)</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    len_y_v = len(y_v)</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    len_z_v = len(z_v)</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    </div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    len_x_w = len(x_w)</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    len_y_w = len(y_w)</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    len_z_w = len(z_w)</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    </div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    len_t = len(t)</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    x_stream = np.ones((int(t_int/delta_t)+2))*startx</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    y_stream = np.ones((int(t_int/delta_t)+2))*starty</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    z_stream = np.ones((int(t_int/delta_t)+2))*startz</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    t_stream = np.ones((int(t_int/delta_t)+2))*startt</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    t_RK = startt <span class="comment">#set the initial time to be the given start time</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    z_RK = startz</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    y_RK = starty</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    x_RK = startx</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    </div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    i=0</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    u_netcdf_filehandle = netCDF4.Dataset(u_netcdf_filename)</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    v_netcdf_filehandle = netCDF4.Dataset(v_netcdf_filename)</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    w_netcdf_filehandle = netCDF4.Dataset(w_netcdf_filename)</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    </div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    t_index = np.searchsorted(t,t_RK)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    t_index_new = np.searchsorted(t,t_RK) <span class="comment"># this is later used to test if new data needs to be read in.</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordflow">if</span> t_index == 0:</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&#39;Given time value is outside the given velocity fields - too small&#39;</span>)</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">elif</span> t_index == len_t:</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&#39;Given time value is outside the given velocity fields - too big&#39;</span>)</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    </div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    <span class="comment"># load fields in ready for the first run through the loop</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="comment">#  u</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    u_field,x_index_u,y_index_u,z_index_u = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_u,y_u,z_u,</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                                                x_RK,y_RK,z_RK,t_index,</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                                                len_x_u,len_y_u,len_z_u,len_t,</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                                                u_netcdf_filehandle,u_netcdf_variable)</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    u_field,x_index_u_new,y_index_u_new,z_index_u_new = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_u,y_u,z_u,</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                                                x_RK,y_RK,z_RK,t_index,</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                                                len_x_u,len_y_u,len_z_u,len_t,</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                                                u_netcdf_filehandle,u_netcdf_variable)</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="comment">#  v</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    v_field,x_index_v,y_index_v,z_index_v = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_v,y_v,z_v,</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                                                x_RK,y_RK,z_RK,t_index,</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                                                len_x_v,len_y_v,len_z_v,len_t,</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                                                v_netcdf_filehandle,v_netcdf_variable)</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    v_field,x_index_v_new,y_index_v_new,z_index_v_new = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_v,y_v,z_v,</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                                                x_RK,y_RK,z_RK,t_index,</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                                                len_x_v,len_y_v,len_z_v,len_t,</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                                                v_netcdf_filehandle,v_netcdf_variable)</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="comment">#  w</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    w_field,x_index_w,y_index_w,z_index_w = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_w,y_w,z_w,</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                                                x_RK,y_RK,z_RK,t_index,</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                                                len_x_w,len_y_w,len_z_w,len_t,</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                                                w_netcdf_filehandle,w_netcdf_variable)</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    </div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    w_field,x_index_w_new,y_index_w_new,z_index_w_new = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_w,y_w,z_w,</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                                                x_RK,y_RK,z_RK,t_index,</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                                                len_x_w,len_y_w,len_z_w,len_t,</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                                                w_netcdf_filehandle,w_netcdf_variable)</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    </div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    </div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="comment"># Runge-Kutta fourth order method to estimate next position.</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="keywordflow">while</span> i &lt; np.fabs(t_int/delta_t):</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="comment">#t_RK &lt; t_int + startt:</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        <span class="comment"># Compute indices at location given</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        </div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="keywordflow">if</span> (y_index_u_new==y_index_u <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            x_index_u_new==x_index_u <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            z_index_u_new==z_index_u <span class="keywordflow">and</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;            </div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            y_index_v_new==y_index_v <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            x_index_v_new==x_index_v <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            z_index_v_new==z_index_v <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            y_index_w_new==y_index_w <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            x_index_w_new==x_index_w <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;            z_index_w_new==z_index_w <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            t_index_new == t_index):</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;            <span class="comment"># the particle hasn&#39;t moved out of the grid cell it was in.</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            <span class="comment"># So the loaded field is fine; there&#39;s no need to reload it.</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;            <span class="keywordflow">pass</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            t_index = np.searchsorted(t,t_RK)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            <span class="keywordflow">if</span> t_index == 0:</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&#39;Given time value is outside the given velocity fields - too small&#39;</span>)</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            <span class="keywordflow">elif</span> t_index == len_t:</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&#39;Given time value is outside the given velocity fields - too big&#39;</span>)</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            <span class="comment"># for u</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            u_field,x_index_u,y_index_u,z_index_u = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_u,y_u,z_u,</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                                                        x_RK,y_RK,z_RK,t_index,</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                                                        len_x_u,len_y_u,len_z_u,len_t,</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                                                        u_netcdf_filehandle,u_netcdf_variable)</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            <span class="comment"># for v</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            v_field,x_index_v,y_index_v,z_index_v = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_v,y_v,z_v,</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                                                        x_RK,y_RK,z_RK,t_index,</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                                                        len_x_v,len_y_v,len_z_v,len_t,</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                                                        v_netcdf_filehandle,v_netcdf_variable)</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;            <span class="comment"># for w</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;            w_field,x_index_w,y_index_w,z_index_w = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_w,y_w,z_w,</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                                                        x_RK,y_RK,z_RK,t_index,</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                                                        len_x_w,len_y_w,len_z_w,len_t,</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                                                        w_netcdf_filehandle,w_netcdf_variable)</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="comment"># Interpolate velocities to initial location</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        u_loc = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK,y_RK,z_RK,t_RK,</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                    u_field,</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                    x_u,y_u,z_u,t,</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                    len_x_u,len_y_u,len_z_u,len_t,</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                    x_index_u,y_index_u,z_index_u,t_index)</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        v_loc = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK,y_RK,z_RK,t_RK,</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                    v_field,</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                    x_v,y_v,z_v,t,len_x_v,len_y_v,len_z_v,len_t,</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                    x_index_v,y_index_v,z_index_v,t_index)</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        w_loc = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK,y_RK,z_RK,t_RK,</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                    w_field,</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                    x_w,y_w,z_w,t,len_x_w,len_y_w,len_z_w,len_t,</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                    x_index_w,y_index_w,z_index_w,t_index)</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        dx1 = delta_t*u_loc</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        dy1 = delta_t*v_loc</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        dz1 = delta_t*w_loc</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        u_loc1 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK + 0.5*dx1,y_RK + 0.5*dy1,z_RK + 0.5*dz1,t_RK + 0.5*delta_t,</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                    u_field,</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                    x_u,y_u,z_u,t,len_x_u,len_y_u,len_z_u,len_t,</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                    x_index_u,y_index_u,z_index_u,t_index)</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        v_loc1 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK + 0.5*dx1,y_RK + 0.5*dy1,z_RK + 0.5*dz1,t_RK + 0.5*delta_t,</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                    v_field,</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                    x_v,y_v,z_v,t,len_x_v,len_y_v,len_z_v,len_t,</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                    x_index_v,y_index_v,z_index_v,t_index)</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        w_loc1 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK + 0.5*dx1,y_RK + 0.5*dy1,z_RK + 0.5*dz1,t_RK + 0.5*delta_t,</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                    w_field,</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                    x_w,y_w,z_w,t,len_x_w,len_y_w,len_z_w,len_t,</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                    x_index_w,y_index_w,z_index_w,t_index)</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        dx2 = delta_t*u_loc1</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        dy2 = delta_t*v_loc1</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        dz2 = delta_t*w_loc1</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        u_loc2 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK + 0.5*dx2,y_RK + 0.5*dy2,z_RK + 0.5*dz2,t_RK + 0.5*delta_t,</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                    u_field,</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                    x_u,y_u,z_u,t,len_x_u,len_y_u,len_z_u,len_t,</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                    x_index_u,y_index_u,z_index_u,t_index)</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        v_loc2 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK + 0.5*dx2,y_RK + 0.5*dy2,z_RK + 0.5*dz2,t_RK + 0.5*delta_t,</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                    v_field,</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                    x_v,y_v,z_v,t,len_x_v,len_y_v,len_z_v,len_t,</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                    x_index_v,y_index_v,z_index_v,t_index)</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        w_loc2 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK + 0.5*dx2,y_RK + 0.5*dy2,z_RK + 0.5*dz2,t_RK + 0.5*delta_t,</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                    w_field,</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                    x_w,y_w,z_w,t,len_x_w,len_y_w,len_z_w,len_t,</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                    x_index_w,y_index_w,z_index_w,t_index)</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        dx3 = delta_t*u_loc2</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        dy3 = delta_t*v_loc2</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        dz3 = delta_t*w_loc2</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        u_loc3 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK + dx3,y_RK + dy3,z_RK + dz3,t_RK + delta_t,</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                    u_field,</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                    x_u,y_u,z_u,t,len_x_u,len_y_u,len_z_u,len_t,</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                    x_index_u,y_index_u,z_index_u,t_index)</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        v_loc3 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK + dx3,y_RK + dy3,z_RK + dz3,t_RK + delta_t,</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                    v_field,</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                    x_v,y_v,z_v,t,len_x_v,len_y_v,len_z_v,len_t,</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                    x_index_v,y_index_v,z_index_v,t_index)</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        w_loc3 = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x_RK + dx3,y_RK + dy3,z_RK + dz3,t_RK + delta_t,</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                    w_field,</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                    x_w,y_w,z_w,t,len_x_w,len_y_w,len_z_w,len_t,</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                    x_index_w,y_index_w,z_index_w,t_index)</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        dx4 = delta_t*u_loc3</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        dy4 = delta_t*v_loc3</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        dz4 = delta_t*w_loc3</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        <span class="comment">#recycle the variables to keep the code clean</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        x_RK = x_RK + (dx1 + 2*dx2 + 2*dx3 + dx4)/6</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        y_RK = y_RK + (dy1 + 2*dy2 + 2*dy3 + dy4)/6</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        z_RK = z_RK + (dz1 + 2*dz2 + 2*dz3 + dz4)/6</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        t_RK += delta_t</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        i += 1</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        x_stream[i] = x_RK</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        y_stream[i] = y_RK</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        z_stream[i] = z_RK</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        t_stream[i] = t_RK</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        </div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        t_index_new = np.searchsorted(t,t_RK)</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        x_index_w_new = np.searchsorted(x_w,x_RK)</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        y_index_w_new = np.searchsorted(y_w,y_RK)</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;        <span class="keywordflow">if</span> z_RK &lt; 0:</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;            z_index_w_new = np.searchsorted(-z_w,-z_RK)</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            z_index_w_new = np.searchsorted(z_w,z_RK)</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            </div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        x_index_v_new = np.searchsorted(x_v,x_RK)</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        y_index_v_new = np.searchsorted(y_v,y_RK)</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="keywordflow">if</span> z_RK &lt; 0:</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;            z_index_v_new = np.searchsorted(-z_v,-z_RK)</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            z_index_v_new = np.searchsorted(z_v,z_RK)</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            </div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        x_index_u_new = np.searchsorted(x_u,x_RK)</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        y_index_u_new = np.searchsorted(y_u,y_RK)</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="keywordflow">if</span> z_RK &lt; 0:</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            z_index_u_new = np.searchsorted(-z_u,-z_RK)</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            z_index_u_new = np.searchsorted(z_u,z_RK)</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  </div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    u_netcdf_filehandle.close()</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    v_netcdf_filehandle.close()</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    w_netcdf_filehandle.close()</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="keywordflow">return</span> x_stream,y_stream,z_stream,t_stream</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div>
<div class="line"><a name="l00436"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">  436</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(x0,y0,field,x,y,len_x,len_y):</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  <span class="stringliteral">&quot;&quot;&quot;!Do bilinear interpolation of a field. This function assumes that the grid can locally be regarded as cartesian, with everything at right angles.</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="stringliteral">  x0,y0 are the points to interpolate to.</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="stringliteral">  &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  <span class="comment"># Compute indeces at location</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  x_index = np.searchsorted(x,x0)</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keywordflow">if</span> x_index == 0:</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    x_index =1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <span class="comment">#raise ValueError(&#39;x location &#39;, str(x0), &#39; is outside the model grid - too small&#39;)</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keywordflow">elif</span> x_index == len_x:</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    x_index =len_x - 1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <span class="comment">#raise ValueError(&#39;x location &#39;, str(x0), &#39; is outside the model grid - too big&#39;)</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    </div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  y_index = np.searchsorted(y,y0)</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="keywordflow">if</span> y_index == 0:</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    y_index =1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    <span class="comment">#raise ValueError(&#39;y location &#39;, str(y0), &#39; is outside the model grid - too small&#39;)</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="keywordflow">elif</span> y_index == len_y:</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    y_index =len_y - 1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="comment">#raise ValueError(&#39;y location &#39;, str(y0), &#39; is outside the model grid - too big&#39;)</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  </div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="comment">#print &#39;x index = &#39; + str(x_index)</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  <span class="comment">#print &#39;y index = &#39; + str(y_index)</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    </div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  field_interp = <a class="code" href="namespacemitgcm_1_1streamlines.html#af0379625b51f588355836dd3711aae7c">actual_bilinear_interp</a>(field,x0,y0,x,y,len_x,len_y,x_index,y_index)</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keywordflow">return</span> field_interp</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  </div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;@numba.jit</div>
<div class="line"><a name="l00466"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#af0379625b51f588355836dd3711aae7c">  466</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#af0379625b51f588355836dd3711aae7c">actual_bilinear_interp</a>(field,x0,y0,x,y,len_x,len_y,x_index,y_index):</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!This is a numba accelerated bilinear interpolation. The @numba.jit decorator just above this function causes it to be compiled just before it is run. This introduces a small, Order(1 second), overhead the first time, but not on subsequent calls. </span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    field_interp = ((field[y_index-1,x_index-1]*(x[x_index] - x0)*(y[y_index] - y0) + </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;       field[y_index-1,x_index]*(x0 - x[x_index-1])*(y[y_index] - y0) +</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;       field[y_index,x_index]*(x[x_index] - x0)*(y0 - y[y_index-1]) + </div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;       field[y_index,x_index]*(x0 - x[x_index-1])*(y0 - y[y_index-1]))/</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;       ((y[y_index] - y[y_index-1])*(x[x_index] - x[x_index-1]))) </div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordflow">return</span> field_interp</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;  </div>
<div class="line"><a name="l00477"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">  477</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(x0,y0,z0,field,x,y,z,len_x,len_y,len_z):</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  <span class="stringliteral">&quot;&quot;&quot;!Do trilinear interpolation of the field in three spatial dimensions. This function assumes that the grid can locally be regarded as cartesian, with everything at right angles. It also requires that the entire field can be held in memory at the same time.</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="stringliteral">  x0,y0, and z0 represent the point to interpolate to.</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="stringliteral">  &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;  <span class="comment"># Compute indices at location given</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  x_index = np.searchsorted(x,x0)</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  <span class="keywordflow">if</span> x_index == 0:</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    x_index =1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="comment">#raise ValueError(&#39;x location &#39;, str(x0), &#39; is outside the model grid - too small&#39;)</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;  <span class="keywordflow">elif</span> x_index == len_x:</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    x_index =len_x - 1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="comment">#raise ValueError(&#39;x location &#39;, str(x0), &#39; is outside the model grid - too big&#39;)</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    </div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  y_index = np.searchsorted(y,y0)</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <span class="keywordflow">if</span> y_index == 0:</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    y_index =1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="comment">#raise ValueError(&#39;y location &#39;, str(y0), &#39; is outside the model grid - too small&#39;)</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <span class="keywordflow">elif</span> y_index == len_y:</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    y_index =len_y - 1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">#raise ValueError(&#39;y location &#39;, str(y0), &#39; is outside the model grid - too big&#39;)</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  </div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;  <span class="comment"># np.searchsorted only works for positive arrays :/</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="keywordflow">if</span> z0 &lt; 0:</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        z0 = -z0</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        z = -z</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;  z_index = np.searchsorted(z,z0)</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  <span class="keywordflow">if</span> z_index == 0:</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    z_index =1 <span class="comment"># a dirty hack to deal with streamlines coming near the surface</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    <span class="comment">#raise ValueError(&#39;z location &#39;, str(z0), &#39; is outside the model grid - too small&#39;)</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <span class="keywordflow">elif</span> z_index == len_z:</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    z_index = len_z - 1 <span class="comment"># a dirty hack to deal with streamlines coming near the bottom</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="comment">#raise ValueError(&#39;z location &#39;, str(z0), &#39; is outside the model grid - too big&#39;)</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  <span class="comment">#print &#39;x index = &#39; + str(x_index)</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;  <span class="comment">#print &#39;y index = &#39; + str(y_index)</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    </div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  field_interp = <a class="code" href="namespacemitgcm_1_1streamlines.html#aa84595e731400d5c213a2cf663ed833d">actual_trilinear_interp</a>(field,x0,y0,z0,x_index,y_index,z_index,x,y,z)</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;  <span class="keywordflow">return</span> field_interp</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;@numba.jit</div>
<div class="line"><a name="l00520"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#aa84595e731400d5c213a2cf663ed833d">  520</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#aa84595e731400d5c213a2cf663ed833d">actual_trilinear_interp</a>(field,x0,y0,z0,x_index,y_index,z_index,x,y,z):</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!This is a numba accelerated trilinear interpolation. The @numba.jit decorator just above this function causes it to be compiled just before it is run. This introduces a small, Order(1 second), overhead the first time, but not on subsequent calls. </span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span>   </div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    field_interp = ((field[z_index-1,y_index-1,x_index-1]*</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        (x[x_index] - x0)*(y[y_index] - y0)*(z[z_index] - z0) + </div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        field[z_index,y_index-1,x_index-1]*</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        (x[x_index] - x0)*(y[y_index] - y0)*(z0 - z[z_index-1]) + </div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        field[z_index,y_index,x_index-1]*</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        (x[x_index] - x0)*(y0 - y[y_index-1])*(z0 - z[z_index-1]) + </div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        field[z_index-1,y_index,x_index-1]*</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        (x[x_index] - x0)*(y0 - y[y_index-1])*(z[z_index] - z0) + </div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        field[z_index-1,y_index-1,x_index]*</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        (x0 - x[x_index-1])*(y[y_index] - y0)*(z[z_index] - z0) + </div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        field[z_index,y_index-1,x_index]*</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        (x0 - x[x_index-1])*(y[y_index] - y0)*(z0 - z[z_index-1]) + </div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        field[z_index,y_index,x_index]*</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        (x0 - x[x_index-1])*(y0 - y[y_index-1])*(z0 - z[z_index-1]) + </div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        field[z_index-1,y_index,x_index]*</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        (x0 - x[x_index-1])*(y0 - y[y_index-1])*(z[z_index] - z0))/</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;      ((z[z_index] - z[z_index-1])*(y[y_index] - y[y_index-1])*(x[x_index] - x[x_index-1]))) </div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">return</span> field_interp</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(x0,y0,z0,t0,</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                        field,</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                        x,y,z,t,</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                        len_x,len_y,len_z,len_t,</div>
<div class="line"><a name="l00546"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">  546</a></span>&#160;                        x_index,y_index,z_index,t_index):</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;  <span class="stringliteral">&quot;&quot;&quot;! Do quadralinear interpolation of the velocity field in three spatial dimensions and one temporal dimension to get nice accurate streaklines. This function assumes that the grid can locally be regarded as cartesian, with everything at right angles.</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="stringliteral">  x0,y0,z0, and t0 represent the point to interpolate to.</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="stringliteral">  The velocity field, &quot;field&quot;, is passed as a truncated 4D field.</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="stringliteral">  </span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="stringliteral">  x,y,z,t are vectors of these dimensions.</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="stringliteral">  &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  <span class="comment"># These searchsorted calls are to check if the location has crossed a grid cell. </span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  <span class="comment"># With very small time steps they&#39;re probably irrelevant.</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;  <span class="comment"># The +2 is to make the index zero at the location of interest.</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    </div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;  <span class="comment"># Compute indices at location</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  x_index_shifted = np.searchsorted(x,x0) - x_index + 2</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  <span class="comment">#if x_index == 0:</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  <span class="comment">#  raise ValueError(&#39;Given x location is outside the truncated field - too small. This error should never be seen.&#39;)</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;  <span class="comment">#elif x_index == 4:</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  <span class="comment">#  raise ValueError(&#39;Given x location is outside the truncated field - too big. This error should never be seen.&#39;)</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    </div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  y_index_shifted = np.searchsorted(y,y0) - y_index + 2</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  <span class="comment">#if y_index_shifted == 0:</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  <span class="comment">#  raise ValueError(&#39;Given y location is outside the truncated field - too small. This error should never be seen.&#39;)</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="comment">#elif y_index_shifted == 4:</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;  <span class="comment">#  raise ValueError(&#39;Given y location is outside the truncated field - too big. This error should never be seen.&#39;)</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  </div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;  <span class="comment"># np.searchsorted only works for positive arrays, so z needs to be positive :/</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  <span class="keywordflow">if</span> z0 &lt; 0:</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        z0 = -z0</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        z = -z</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  z_index_shifted = np.searchsorted(z,z0) - z_index + 2</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <span class="comment">#if z_index_shifted == 0:</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  <span class="comment">#  raise ValueError(&#39;Given z location is outside the truncated field - too small. This error should never be seen.&#39;)</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  <span class="comment">#elif z_index_shifted == 4:</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;  <span class="comment">#  raise ValueError(&#39;Given z location is outside the truncated field - too big. This error should never be seen.&#39;)</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  t_index_shifted = np.searchsorted(t,t0) - t_index + 2</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  <span class="comment">#if t_index_shifted == 0:</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  <span class="comment">#  raise ValueError(&#39;Given t location is outside the truncated field - too small. This error should never be seen.&#39;)</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <span class="comment">#elif t_index_shifted == 3:</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  <span class="comment">#  raise ValueError(&#39;Given t location is outside the truncated field - too big. This error should never be seen.&#39;)</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  </div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  field_interp = <a class="code" href="namespacemitgcm_1_1streamlines.html#aac1a8a54def68d4a7f0698c9809db4ef">actual_quadralinear_interp</a>(field[t_index_shifted-1:t_index_shifted+1,</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                       z_index_shifted-1:z_index_shifted+1,</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                       y_index_shifted-1:y_index_shifted+1,</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                       x_index_shifted-1:x_index_shifted+1],</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                        x0,y0,z0,t0,</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                        x_index,y_index,z_index,t_index,</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                        x,y,z,t)</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  <span class="keywordflow">return</span> field_interp</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;@numba.jit</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#aac1a8a54def68d4a7f0698c9809db4ef">actual_quadralinear_interp</a>(field,x0,y0,z0,t0,</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                               x_index,y_index,z_index,t_index,</div>
<div class="line"><a name="l00603"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#aac1a8a54def68d4a7f0698c9809db4ef">  603</a></span>&#160;                               x,y,z,t):</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;  <span class="stringliteral">&quot;&quot;&quot;!This is a numba accelerated quadralinear interpolation. The @numba.jit decorator just above this function causes it to be compiled just before it is run. This introduces a small, Order(1 second), overhead the first time, but not on subsequent</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="stringliteral">  calls. </span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="stringliteral">  &quot;&quot;&quot;</span>   </div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;  field_interp = ((field[0,0,0,0]*</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                    (x[x_index] - x0)*(y[y_index] - y0)*(z[z_index] - z0)*(t[t_index] - t0) + </div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                field[0,1,0,0]*</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                    (x[x_index] - x0)*(y[y_index] - y0)*(z0 - z[z_index-1])*(t[t_index] - t0) + </div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                field[0,1,1,0]*</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                    (x[x_index] - x0)*(y0 - y[y_index-1])*(z0 - z[z_index-1])*(t[t_index] - t0) + </div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                field[0,0,1,0]*</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                    (x[x_index] - x0)*(y0 - y[y_index-1])*(z[z_index] - z0)*(t[t_index] - t0) + </div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                field[0,0,0,1]*</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                    (x0 - x[x_index-1])*(y[y_index] - y0)*(z[z_index] - z0)*(t[t_index] - t0) + </div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                field[0,1,0,1]*</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                    (x0 - x[x_index-1])*(y[y_index] - y0)*(z0 - z[z_index-1])*(t[t_index] - t0) +        </div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                field[0,1,1,1]*</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                    (x0 - x[x_index-1])*(y0 - y[y_index-1])*(z0 - z[z_index-1])*(t[t_index] - t0) + </div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                field[0,0,1,1]*</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                    (x0 - x[x_index-1])*(y0 - y[y_index-1])*(z[z_index] - z0)*(t[t_index] - t0) +</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                    </div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                field[1,0,0,0]*</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                    (x[x_index] - x0)*(y[y_index] - y0)*(z[z_index] - z0)*(t0 - t[t_index-1]) + </div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                field[1,1,0,0]*</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                    (x[x_index] - x0)*(y[y_index] - y0)*(z0 - z[z_index-1])*(t0 - t[t_index-1]) + </div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                field[1,1,1,0]*</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                    (x[x_index] - x0)*(y0 - y[y_index-1])*(z0 - z[z_index-1])*(t0 - t[t_index-1]) + </div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                field[1,0,1,0]*</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                    (x[x_index] - x0)*(y0 - y[y_index-1])*(z[z_index] - z0)*(t0 - t[t_index-1]) + </div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                field[1,0,0,1]*</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                    (x0 - x[x_index-1])*(y[y_index] - y0)*(z[z_index] - z0)*(t0 - t[t_index-1]) + </div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                field[1,1,0,1]*</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                    (x0 - x[x_index-1])*(y[y_index] - y0)*(z0 - z[z_index-1])*(t0 - t[t_index-1]) + </div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                field[1,1,1,1]*</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                    (x0 - x[x_index-1])*(y0 - y[y_index-1])*(z0 - z[z_index-1])*(t0 - t[t_index-1]) + </div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                field[1,0,1,1]*</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                    (x0 - x[x_index-1])*(y0 - y[y_index-1])*(z[z_index] - z0)*(t0 - t[t_index-1]))/</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;             ((t[t_index] - t[t_index-1])*(z[z_index] - z[z_index-1])*</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;              (y[y_index] - y[y_index-1])*(x[x_index] - x[x_index-1])))</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    </div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  <span class="keywordflow">return</span> field_interp</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x,y,z,</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                        startx,starty,startz,t_index,</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                        len_x,len_y,len_z,len_t,</div>
<div class="line"><a name="l00652"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">  652</a></span>&#160;                        netcdf_filehandle,variable):</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            <span class="stringliteral">&quot;&quot;&quot;!A helper function to extract a small 4D hypercube of data from a netCDF file. This isn&#39;t intended to be used on its own.&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            </div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            <span class="comment"># Compute indices at location given</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            x_index = np.searchsorted(x,x0)</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;            <span class="keywordflow">if</span> x_index == 0:</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                x_index = 1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                <span class="comment">#raise ValueError(&#39;x location &#39;, str(x0), &#39; is outside the model grid - too small&#39;)</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;            <span class="keywordflow">elif</span> x_index == len_x:</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                x_index =len_x - 1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                <span class="comment">#raise ValueError(&#39;x location &#39;, str(x0), &#39; is outside the model grid - too big&#39;)</span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            y_index = np.searchsorted(y,y0)</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            <span class="keywordflow">if</span> y_index == 0:</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                y_index =1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                <span class="comment">#raise ValueError(&#39;y location &#39;, str(y0), &#39; is outside the model grid - too small&#39;)</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;            <span class="keywordflow">elif</span> y_index == len_y:</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                y_index =len_y - 1 <span class="comment"># a dirty hack to deal with streamlines coming near the edge</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                <span class="comment">#raise ValueError(&#39;y location &#39;, str(y0), &#39; is outside the model grid - too big&#39;)</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;            <span class="comment"># np.searchsorted only works for positive arrays :/</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            <span class="keywordflow">if</span> z0 &lt; 0:</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;                z0 = -z0</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                z = -z</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;            z_index = np.searchsorted(z,z0)</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;            <span class="keywordflow">if</span> z_index == 0:</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                z_index =1 <span class="comment"># a dirty hack to deal with streamlines coming near the surface</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                <span class="comment">#raise ValueError(&#39;z location &#39;, str(z0), &#39; is outside the model grid - too small&#39;)</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            <span class="keywordflow">elif</span> z_index == len_z:</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                z_index = len_z - 1 <span class="comment"># a dirty hack to deal with streamlines coming near the bottom</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                <span class="comment">#raise ValueError(&#39;z location &#39;, str(z0), &#39; is outside the model grid - too big&#39;)</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;            field = netcdf_filehandle.variables[variable][t_index-2:t_index+3,</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;                           z_index-2:z_index+3,</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                           y_index-2:y_index+3,</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                           x_index-2:x_index+3]</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;            </div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;            <span class="keywordflow">return</span> field,x_index,y_index,z_index</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            </div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;            </div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#a290cc434dcffbedea22dcc00c75713dc">extract_along_path4D</a>(path_x,path_y,path_z,path_t,</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            x_axis,y_axis,z_axis,t_axis,</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;            netcdf_filename=<span class="stringliteral">&#39;netcdf file with variable of interest&#39;</span>,</div>
<div class="line"><a name="l00697"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#a290cc434dcffbedea22dcc00c75713dc">  697</a></span>&#160;            netcdf_variable=<span class="stringliteral">&#39;momVort3&#39;</span>):</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!extract the value of a field along a path through a time varying, 3 dimensional field. The field must be in a NetCDF file, since it is assumed to be 4D and very large.</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="stringliteral"></span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="stringliteral">    This can also be used to pull out values at specific locations and times.</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    t_index = np.searchsorted(t_axis,path_t[0])</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    t_index_new = np.searchsorted(t_axis,path_t[0]) <span class="comment"># this is later used to test if new data needs to be read in.</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        </div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    len_x = len(x_axis)</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    len_y = len(y_axis)</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    len_z = len(z_axis)</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    len_t = len(t_axis)</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    </div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    netcdf_filehandle = netCDF4.Dataset(netcdf_filename)  </div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    field,x_index,y_index,z_index = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_axis,y_axis,z_axis,</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                                            path_x[0],path_y[0],path_z[0],t_index,</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                                            len_x,len_y,len_z,len_t,</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                                            netcdf_filehandle,netcdf_variable)</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    field,x_index_new,y_index_new,z_index_new = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_axis,y_axis,z_axis,</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                                            path_x[0],path_y[0],path_z[0],t_index,</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                                            len_x,len_y,len_z,len_t,</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                                            netcdf_filehandle,netcdf_variable)   </div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    path_variable = np.zeros((path_x.shape))</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    </div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    i=0</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    </div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <span class="keywordflow">if</span> t_index == 0:</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&#39;Given start time is outside the given variable field - too small&#39;</span>)</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    <span class="keywordflow">elif</span> t_index == len_t:</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&#39;Given start time is outside the given variable field - too big&#39;</span>)</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    </div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    </div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(0,len(path_t)):</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="keywordflow">if</span> (y_index_new==y_index <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;            x_index_new==x_index <span class="keywordflow">and</span> </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;            z_index_new==z_index <span class="keywordflow">and</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;            t_index_new == t_index):</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;            <span class="comment"># the particle hasn&#39;t moved out of the grid cell it was in.</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;            <span class="comment"># So the loaded field is fine; there&#39;s no need to reload it.</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;            <span class="keywordflow">pass</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;            t_index = np.searchsorted(t,path_t[i])</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;            <span class="keywordflow">if</span> t_index == 0:</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&#39;Time value is outside the given variable field - too small&#39;</span>)</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;            <span class="keywordflow">elif</span> t_index == len_t:</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&#39;Time value is outside the given variable field - too big&#39;</span>)</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;            field,x_index,y_index,z_index = <a class="code" href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">indices_and_field</a>(x_axis,y_axis,z_axis,</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                                            path_x[i],path_y[i],path_z[i],t_index,</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                                            len_x,len_y,len_z,len_t,</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                                            netcdf_filehandle,netcdf_variable)</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        <span class="comment"># Interpolate field to  location</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        field_at_loc = <a class="code" href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">quadralinear_interp</a>(path_x[i],path_y[i],path_z[i],path_t[i],</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                    field,</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;                    x_axis,y_axis,z_axis,t_axis,</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                    len_x,len_y,len_z,len_t,</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;                    x_index,y_index,z_index,t_index)</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;      </div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        path_variable[i] = field_at_loc</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        t_index_new = np.searchsorted(t_axis,path_t[i])</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;        x_index_new = np.searchsorted(x_axis,path_x[i])</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        y_index_new = np.searchsorted(y_axis,path_y[i])</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        <span class="keywordflow">if</span> path_z[i] &lt; 0:</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            z_index_new = np.searchsorted(-z_axis,-path_z[i])</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            z_index_new = np.searchsorted(z_axis,path_z[i])</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;            </div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    netcdf_filehandle.close()</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    </div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="keywordflow">return</span> path_variable</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#a8280cf3b53590039168174aa93a0e4c5">extract_along_path3D</a>(path_x,path_y,path_z,</div>
<div class="line"><a name="l00787"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#a8280cf3b53590039168174aa93a0e4c5">  787</a></span>&#160;            x_axis,y_axis,z_axis,field):</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!Extract the value of a field along a path through a 3 dimensional field. The field must be passed as an array. Time varying fields are not supported.</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        </div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    len_x = len(x_axis)</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    len_y = len(y_axis)</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    len_z = len(z_axis)</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    path_variable = np.zeros((path_x.shape))</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    </div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(0,len(path_x)):</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <span class="comment"># Interpolate field to  location</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        path_variable[i] = <a class="code" href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">trilinear_interp</a>(path_x[i],path_y[i],path_z[i],field,x_axis,y_axis,z_axis,len_x,len_y,len_z)</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                </div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordflow">return</span> path_variable</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="keyword">def </span><a class="code" href="namespacemitgcm_1_1streamlines.html#ad194702b26f7e8aa7eeceeeb987a6d29">extract_along_path2D</a>(path_x,path_y,</div>
<div class="line"><a name="l00807"></a><span class="lineno"><a class="line" href="namespacemitgcm_1_1streamlines.html#ad194702b26f7e8aa7eeceeeb987a6d29">  807</a></span>&#160;            x_axis,y_axis,field):</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!Extract the value of a field along a path through a 2 dimensional field. The field must be passed as an array. Time varying fields are not supported.</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;        </div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    len_x = len(x_axis)</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    len_y = len(y_axis)</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    path_variable = np.zeros((path_x.shape))</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    </div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(0,len(path_x)):</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        <span class="comment"># Interpolate field to  location</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        path_variable[i] = <a class="code" href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">bilinear_interp</a>(path_x[i],path_y[i],field,x_axis,y_axis,len_x,len_y)</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                </div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="keywordflow">return</span> path_variable</div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_a71006df0268068f667797deefae99b73"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#a71006df0268068f667797deefae99b73">mitgcm.streamlines.quadralinear_interp</a></div><div class="ttdeci">def quadralinear_interp(x0, y0, z0, t0, field, x, y, z, t, len_x, len_y, len_z, len_t, x_index, y_index, z_index, t_index)</div><div class="ttdoc">Do quadralinear interpolation of the velocity field in three spatial dimensions and one temporal dime...</div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00546">streamlines.py:546</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_aa84595e731400d5c213a2cf663ed833d"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#aa84595e731400d5c213a2cf663ed833d">mitgcm.streamlines.actual_trilinear_interp</a></div><div class="ttdeci">def actual_trilinear_interp(field, x0, y0, z0, x_index, y_index, z_index, x, y, z)</div><div class="ttdoc">This is a numba accelerated trilinear interpolation. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00520">streamlines.py:520</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_a290cc434dcffbedea22dcc00c75713dc"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#a290cc434dcffbedea22dcc00c75713dc">mitgcm.streamlines.extract_along_path4D</a></div><div class="ttdeci">def extract_along_path4D</div><div class="ttdoc">extract the value of a field along a path through a time varying, 3 dimensional field. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00697">streamlines.py:697</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_ab47d978fd4c41aa2c413b3f97fc7a7ac"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#ab47d978fd4c41aa2c413b3f97fc7a7ac">mitgcm.streamlines.trilinear_interp</a></div><div class="ttdeci">def trilinear_interp(x0, y0, z0, field, x, y, z, len_x, len_y, len_z)</div><div class="ttdoc">Do trilinear interpolation of the field in three spatial dimensions. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00477">streamlines.py:477</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_ad194702b26f7e8aa7eeceeeb987a6d29"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#ad194702b26f7e8aa7eeceeeb987a6d29">mitgcm.streamlines.extract_along_path2D</a></div><div class="ttdeci">def extract_along_path2D(path_x, path_y, x_axis, y_axis, field)</div><div class="ttdoc">Extract the value of a field along a path through a 2 dimensional field. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00807">streamlines.py:807</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_a38690a408e43bb899018203363da090d"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#a38690a408e43bb899018203363da090d">mitgcm.streamlines.stream3</a></div><div class="ttdeci">def stream3</div><div class="ttdoc">A three-dimensional streamline solver. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00087">streamlines.py:87</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_aac1a8a54def68d4a7f0698c9809db4ef"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#aac1a8a54def68d4a7f0698c9809db4ef">mitgcm.streamlines.actual_quadralinear_interp</a></div><div class="ttdeci">def actual_quadralinear_interp(field, x0, y0, z0, t0, x_index, y_index, z_index, t_index, x, y, z, t)</div><div class="ttdoc">This is a numba accelerated quadralinear interpolation. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00603">streamlines.py:603</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_a8280cf3b53590039168174aa93a0e4c5"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#a8280cf3b53590039168174aa93a0e4c5">mitgcm.streamlines.extract_along_path3D</a></div><div class="ttdeci">def extract_along_path3D(path_x, path_y, path_z, x_axis, y_axis, z_axis, field)</div><div class="ttdoc">Extract the value of a field along a path through a 3 dimensional field. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00787">streamlines.py:787</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_a4522067d3d52d4fc38a5ec611d776702"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#a4522067d3d52d4fc38a5ec611d776702">mitgcm.streamlines.bilinear_interp</a></div><div class="ttdeci">def bilinear_interp(x0, y0, field, x, y, len_x, len_y)</div><div class="ttdoc">Do bilinear interpolation of a field. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00436">streamlines.py:436</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_a493dab136e4b63582d7f6b77e7a9c644"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#a493dab136e4b63582d7f6b77e7a9c644">mitgcm.streamlines.streaklines</a></div><div class="ttdeci">def streaklines</div><div class="ttdoc">A three-dimensional lagrangian particle tracker. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00176">streamlines.py:176</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_ac29e083c45617ad0be326a556c549187"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#ac29e083c45617ad0be326a556c549187">mitgcm.streamlines.indices_and_field</a></div><div class="ttdeci">def indices_and_field(x, y, z, startx, starty, startz, t_index, len_x, len_y, len_z, len_t, netcdf_filehandle, variable)</div><div class="ttdoc">A helper function to extract a small 4D hypercube of data from a netCDF file. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00652">streamlines.py:652</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_af0379625b51f588355836dd3711aae7c"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#af0379625b51f588355836dd3711aae7c">mitgcm.streamlines.actual_bilinear_interp</a></div><div class="ttdeci">def actual_bilinear_interp(field, x0, y0, x, y, len_x, len_y, x_index, y_index)</div><div class="ttdoc">This is a numba accelerated bilinear interpolation. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00466">streamlines.py:466</a></div></div>
<div class="ttc" id="namespacemitgcm_1_1streamlines_html_ac4d6c763bdac75600b3778f4e0ea3a31"><div class="ttname"><a href="namespacemitgcm_1_1streamlines.html#ac4d6c763bdac75600b3778f4e0ea3a31">mitgcm.streamlines.stream2</a></div><div class="ttdeci">def stream2</div><div class="ttdoc">A two-dimensional streamline solver. </div><div class="ttdef"><b>Definition:</b> <a href="streamlines_8py_source.html#l00023">streamlines.py:23</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Mar 12 2015 09:43:55 for mitgcm by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.9.1
</small></address>
</body>
</html>
